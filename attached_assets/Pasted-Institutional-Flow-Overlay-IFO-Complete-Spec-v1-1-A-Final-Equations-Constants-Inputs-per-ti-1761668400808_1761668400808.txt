Institutional Flow Overlay (IFO) â€“ Complete Spec v1.1
A) Final Equations & Constants

Inputs (per ticker):

Quarterly institutional holdings % change (q/q):

ğ»
ğ‘¡
=
InstHold
ğ‘¡
âˆ’
InstHold
ğ‘¡
âˆ’
1
InstHold
ğ‘¡
âˆ’
1
H
t
	â€‹

=
InstHold
tâˆ’1
	â€‹

InstHold
t
	â€‹

âˆ’InstHold
tâˆ’1
	â€‹

	â€‹


Standardize within ticker over last 12 quarters:

ğ‘
ğ»
=
ğ»
ğ‘¡
âˆ’
ğœ‡
(
ğ»
)
ğœ
(
ğ»
)
Z
H
	â€‹

=
Ïƒ(H)
H
t
	â€‹

âˆ’Î¼(H)
	â€‹


Relative volume z-score (daily):

ğ‘…
ğ‘‰
=
ğ‘‰
ğ‘œ
ğ‘™
â€¾
5
ğ‘‘
âˆ’
ğ‘‰
ğ‘œ
ğ‘™
â€¾
100
ğ‘‘
ğœ
(
ğ‘‰
ğ‘œ
ğ‘™
100
ğ‘‘
)
RV=
Ïƒ(Vol
100d
	â€‹

)
Vol
5d
	â€‹

âˆ’
Vol
100d
	â€‹

	â€‹


Accumulation/Distribution (A/D) normalized slope (daily):

MFM
ğ‘‘
=
(
ğ¶
âˆ’
ğ¿
)
âˆ’
(
ğ»
âˆ’
ğ¶
)
max
â¡
(
ğ»
âˆ’
ğ¿
,
ğœ–
)
MFM
d
	â€‹

=
max(Hâˆ’L,Ïµ)
(Câˆ’L)âˆ’(Hâˆ’C)
	â€‹

 with 
ğœ–
=
10
âˆ’
6
Ïµ=10
âˆ’6


MFV
ğ‘‘
=
MFM
ğ‘‘
â‹…
ğ‘‰
ğ‘œ
ğ‘™
ğ‘‘
MFV
d
	â€‹

=MFM
d
	â€‹

â‹…Vol
d
	â€‹



ğ´
ğ·
ğ‘¡
=
âˆ‘
MFV
ğ‘‘
AD
t
	â€‹

=âˆ‘MFV
d
	â€‹

 (cumulative)

ğ´
ğ·
_
ğ‘ 
ğ‘™
ğ‘œ
ğ‘
ğ‘’
=
slope of 
ğ´
ğ·
ğ‘¡
âˆ’
ğ¿
.
.
ğ‘¡
 via OLS
M
A
D
(
ğ´
ğ·
ğ‘¡
âˆ’
120..
ğ‘¡
)
AD_slope=
MAD(AD
tâˆ’120..t
	â€‹

)
slope of AD
tâˆ’L..t
	â€‹

 via OLS
	â€‹

, with 
ğ¿
=
20
L=20.
Clip 
ğ´
ğ·
_
ğ‘ 
ğ‘™
ğ‘œ
ğ‘
ğ‘’
âˆˆ
[
âˆ’
2
,
+
2
]
AD_slopeâˆˆ[âˆ’2,+2].

Short-interest (optional; weekly or semi-monthly):

ğ·
ğ‘‡
ğ¶
ğ‘¡
=
ShortInterest
ğ‘¡
ğ‘‰
ğ‘œ
ğ‘™
â€¾
30
ğ‘‘
DTC
t
	â€‹

=
Vol
30d
	â€‹

ShortInterest
t
	â€‹

	â€‹



Î”
ğ·
ğ‘‡
ğ¶
=
âˆ’
(
ğ·
ğ‘‡
ğ¶
ğ‘¡
âˆ’
ğ·
ğ‘‡
ğ¶
ğ‘¡
âˆ’
1
)
Î”DTC=âˆ’(DTC
t
	â€‹

âˆ’DTC
tâˆ’1
	â€‹

) (improvement bullish)
Standardize over 52 weeks: 
ğ‘
ğ·
ğ‘‡
ğ¶
Z
DTC
	â€‹

.

Raw Institutional Flow Score (weights sum to 1):
Default weights: 
ğ‘¤
1
=
0.45
,
â€…â€Š
ğ‘¤
2
=
0.25
,
â€…â€Š
ğ‘¤
3
=
0.20
,
â€…â€Š
ğ‘¤
4
=
0.10
w
1
	â€‹

=0.45,w
2
	â€‹

=0.25,w
3
	â€‹

=0.20,w
4
	â€‹

=0.10

ğ¼
ğ¹
ğ‘†
ğ‘¡
ğ‘Ÿ
ğ‘
ğ‘¤
=
ğ‘¤
1
ğ‘
ğ»
+
ğ‘¤
2
ğ‘…
ğ‘‰
+
ğ‘¤
3
ğ´
ğ·
_
ğ‘ 
ğ‘™
ğ‘œ
ğ‘
ğ‘’
+
ğ‘¤
4
ğ‘
ğ·
ğ‘‡
ğ¶
IFS
t
raw
	â€‹

=w
1
	â€‹

Z
H
	â€‹

+w
2
	â€‹

RV+w
3
	â€‹

AD_slope+w
4
	â€‹

Z
DTC
	â€‹


Clip: 
ğ¼
ğ¹
ğ‘†
ğ‘¡
ğ‘Ÿ
ğ‘
ğ‘¤
âˆˆ
[
âˆ’
3
,
+
3
]
IFS
t
raw
	â€‹

âˆˆ[âˆ’3,+3].

Smoothing: EMA with half-life 21 trading days (convert half-life to 
ğ›¼
Î±).

ğ¼
ğ¹
ğ‘†
ğ‘¡
=
E
M
A
ğ»
ğ¿
=
21
(
ğ¼
ğ¹
ğ‘†
ğ‘¡
ğ‘Ÿ
ğ‘
ğ‘¤
)
IFS
t
	â€‹

=EMA
HL=21
	â€‹

(IFS
t
raw
	â€‹

)

Rescale to 
[
âˆ’
2
,
+
2
]
[âˆ’2,+2]: winsorize IFS over a rolling 252 trading days at 5th/95th percentiles, then min-max map to 
[
âˆ’
2
,
+
2
]
[âˆ’2,+2].

Integration 1 â€” HMM Posterior Adjustment (complete):
Let 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
P
bull
	â€‹

 be HMM posterior. Use a logit shift with strength 
ğ›¾
Î³.

logit
(
ğ‘
)
=
ln
â¡
ğ‘
1
âˆ’
ğ‘
logit(p)=ln
1âˆ’p
p
	â€‹

, 
ğœ
(
ğ‘¥
)
=
1
1
+
ğ‘’
âˆ’
ğ‘¥
Ïƒ(x)=
1+e
âˆ’x
1
	â€‹


Default 
ğ›¾
=
0.6
Î³=0.6 (tune 0.3â€“0.9)

ğ‘ƒ
~
ğ‘
ğ‘¢
ğ‘™
ğ‘™
=
ğœ
â€‰â£
(
logit
(
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
)
+
ğ›¾
â‹…
ğ¼
ğ¹
ğ‘†
ğ‘¡
)
P
bull
	â€‹

=Ïƒ(logit(P
bull
	â€‹

)+Î³â‹…IFS
t
	â€‹

)

Integration 2 â€” Kelly Scaling (complete):
Let 
ğ¾
ğ‘
ğ‘
ğ‘ 
ğ‘’
K
base
	â€‹

 be Kelly fraction from your edge/odds.

ğ›½
=
0.25
Î²=0.25 (tune 0.1â€“0.4); 
ğ¾
ğ‘š
ğ‘
ğ‘¥
=
0.25
K
max
	â€‹

=0.25.

ğ¾
ğ‘
ğ‘‘
ğ‘—
=
min
â¡
â€‰â£
(
ğ¾
ğ‘š
ğ‘
ğ‘¥
,
â€…â€Š
max
â¡
â€‰â£
(
0
,
â€…â€Š
ğ¾
ğ‘
ğ‘
ğ‘ 
ğ‘’
â‹…
(
1
+
ğ›½
â‹…
ğ¼
ğ¹
ğ‘†
ğ‘¡
)
)
)
K
adj
	â€‹

=min(K
max
	â€‹

,max(0,K
base
	â€‹

â‹…(1+Î²â‹…IFS
t
	â€‹

)))
B) Decision Bands (for â€œDecisionâ€ column)
IFS
ğ‘¡
t
	â€‹

 band	Posterior & Kelly Guidance	Decision
> +1.0	Strong inflow confirmation. Use 
ğ‘ƒ
~
ğ‘
ğ‘¢
ğ‘™
ğ‘™
P
bull
	â€‹

; 
ğ¾
ğ‘
ğ‘‘
ğ‘—
K
adj
	â€‹

 typically â†‘ 15â€“30%.	Increase
0 to +1.0	Mild confirmation. Maintain exposure; no change unless Kelly rules say otherwise.	Maintain
-1.0 to 0	Mild outflow. Reduce 
ğ¾
ğ‘
ğ‘‘
ğ‘—
K
adj
	â€‹

 10â€“20% vs base.	Reduce
< -1.0	Strong outflow. Trim/exit unless 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
>
0.80
P
bull
	â€‹

>0.80 and risk rules allow.	Exit

Tie-breakers:

If 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
<
0.40
P
bull
	â€‹

<0.40, force Exit.

If 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
>
0.80
P
bull
	â€‹

>0.80 and IFS in 
[
0
,
+
1
]
[0,+1], allow Increase.

C) Output Contract (exact fields)

Emit one record per ticker per day:

ticker (string)

date (YYYY-MM-DD)

P_bull_raw (float, 0â€“1)

IFS_raw (float, clipped)

IFS_smoothed (float, rescaled âˆ’2..+2)

P_bull_adj (float, 0â€“1; equals 
ğ‘ƒ
~
ğ‘
ğ‘¢
ğ‘™
ğ‘™
P
bull
	â€‹

)

kelly_base (float, 0..1)

kelly_adj (float, 0..1; equals 
ğ¾
ğ‘
ğ‘‘
ğ‘—
K
adj
	â€‹

)

decision (enum: Increase | Maintain | Reduce | Exit)

components_present (object with booleans: has_ZH, has_RV, has_ADslope, has_ZDTC)

notes (string; e.g., â€œ13F +1.7Ïƒ; RV z=1.1; AD_slope=0.8; DTC n/aâ€)

version (string; â€œIFO v1.1â€)

D) Validation Rules (must pass)

Weight Renormalization: If any input is missing, set its weight to 0 and renormalize remaining 
ğ‘¤
ğ‘–
w
i
	â€‹

 to sum to 1 for that record. Log missing components in components_present.

Clipping/Winsorization: Apply the stated clip/winsorization (IFS_raw in 
[
âˆ’
3
,
+
3
]
[âˆ’3,+3]; IFS_smoothed rescaled to 
[
âˆ’
2
,
+
2
]
[âˆ’2,+2]).

Posterior Monotonicity: If 
ğ¼
ğ¹
ğ‘†
ğ‘¡
IFS
t
	â€‹

 increases by â‰¥1.0 while 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
P
bull
	â€‹

 moves within Â±0.05, then 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
_
ğ‘
ğ‘‘
ğ‘—
P
bull_adj
	â€‹

 must increase.

Kelly Guardrails: Enforce 
0
â‰¤
ğ¾
ğ‘
ğ‘‘
ğ‘—
â‰¤
ğ¾
ğ‘š
ğ‘
ğ‘¥
0â‰¤K
adj
	â€‹

â‰¤K
max
	â€‹

.

Reproducibility: Identical inputs produce identical outputs (no randomness).

Staleness Flags: If 13F data older than 180 days, mark has_ZH=false and renormalize weights.

Numerical Safety: When 
ğ»
=
ğ¿
H=L in A/D math, use 
ğœ–
=
10
âˆ’
6
Ïµ=10
âˆ’6
.

E) Backtest Protocol & A/B Switch

Scope: Same tickers, same date range, same HMM; compare Without IFO vs With IFO overlays.

Switch (boolean): use_IFO âˆˆ {true,false}.

If false: use P_bull_raw and kelly_base.

If true: use P_bull_adj and kelly_adj.

Metrics to report (per run):

Regime precision/recall for bullish calls (threshold 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
>
0.6
P
bull
	â€‹

>0.6)

Portfolio CAGR, Sharpe (daily â†’ annualized), Sortino

Max drawdown

Average Kelly utilization (mean 
ğ¾
K), and variance of 
ğ¾
K

Hit rate on trades (win %) and average win/loss

Pass Criteria (suggested):

Bullish precision lift â‰¥ 5â€“10%

Max DD not worse than baseline

Sharpe same or higher

Kelly variance lower or equal for similar return

Outputs: CSV/JSON with both runs, plus a small summary table.

F) Data-Source Choices (answering Replit)

Institutional Holdings (13F)

For now: Stub via manual CSV for tracked tickers (SOFI, AEIS, LC, ARRY, + your watchlist). Columns: ticker, quarter_end, inst_hold_pct or absolute shares; Replit computes 
ğ»
ğ‘¡
H
t
	â€‹

 and 
ğ‘
ğ»
Z
H
	â€‹

.

Later (optional): SEC EDGAR XML scraping (free, slow). If implemented, cache per quarter; acceptable lag.

Short Interest

Optional. If unavailable, set 
ğ‘¤
4
=
0
w
4
	â€‹

=0 and renormalize. Accept FINRA semi-monthly (free) if desired.

G) Integration Scope (answering Replit)

Apply IFO in all three places:

HMM Trading Signals tab: display P_bull_raw, IFS_smoothed, P_bull_adj, and decision.

Kelly Position Sizing tab: use kelly_adj when use_IFO=true.

Combined Analytics tab: show both raw vs adjusted side-by-side + Decision column.

H) Architecture (no code, boundaries only)

data/institutional_holdings.csv (stubbed 13F q/q)

data/short_interest.csv (optional)

ifo/calculations (module that computes IFS_raw, IFS_smoothed, P_bull_adj, kelly_adj)

ifo/validation (module that enforces rules, logging)

config/ifo.yaml (weights 
ğ‘¤
ğ‘–
w
i
	â€‹

, 
ğ›¾
Î³, 
ğ›½
Î², 
ğ¾
ğ‘š
ğ‘
ğ‘¥
K
max
	â€‹

, bands, half-life, winsor percentiles)

backtest/runner (toggles use_IFO, emits metrics)

Caching: quarterly cache for 13F; daily cache for A/D and RV; recompute IFS once per day per ticker.

I) Edge Cases & Fallbacks

Illiquid days (H=L): MFM=0 (via 
ğœ–
Ïµ guard).

Zero/near-zero volume: set RV=0 for that day.

Recent IPO / sparse 13F: mark has_ZH=false, renormalize.

Extreme outliers: after winsorization, any component > |5Ïƒ| set to sign*5 before weighting.

J) Test Cases (math-only, for QA)

Posterior boost: 
ğ‘ƒ
ğ‘
ğ‘¢
ğ‘™
ğ‘™
=
0.55
P
bull
	â€‹

=0.55, 
ğ¼
ğ¹
ğ‘†
ğ‘¡
=
+
1.2
IFS
t
	â€‹

=+1.2, 
ğ›¾
=
0.6
Î³=0.6.

logit
(
0.55
)
=
0.2007
logit(0.55)=0.2007; add 
0.72
0.72 â†’ 0.9207; 
ğœ
=
0.715
Ïƒ=0.715.
Expect P_bull_adjâ‰ˆ0.715 (Decision likely Increase).

Kelly down-weight: 
ğ¾
ğ‘
ğ‘
ğ‘ 
ğ‘’
=
0.12
K
base
	â€‹

=0.12, 
ğ¼
ğ¹
ğ‘†
ğ‘¡
=
âˆ’
1.0
IFS
t
	â€‹

=âˆ’1.0, 
ğ›½
=
0.25
Î²=0.25.

ğ¾
ğ‘
ğ‘‘
ğ‘—
=
0.12
âˆ—
(
1
âˆ’
0.25
)
=
0.09
K
adj
	â€‹

=0.12âˆ—(1âˆ’0.25)=0.09.

Missing short interest: has_ZDTC=false â†’ 
ğ‘¤
4
=
0
w
4
	â€‹

=0; renormalize other weights to sum 1; log in components_present.

K) Logging & UI Notes

Show a small tooltip on each ticker row:
â€œIFS components: Z_H={x}, RV={y}, AD_slope={z}, Z_DTC={u}; weights={â€¦}.â€

Add a badge: IFS Strong, IFS Weak, IFS Missing13F.

Color-code Decision: Increase (green), Maintain (gray), Reduce (orange), Exit (red).

Priorities for Replit (answering all queue questions)

Do IFS now, separate overlay module (most leverage, minimal coupling).

After itâ€™s stable, add it as a layer in the Screener (filter by IFS band).

Keep Regime-Alert Service unchanged, but include IFS in alert text if available.

Short Answer Block (to paste back to Replit)

Provide full doc above as â€œIFO Spec v1.1.â€

Data sources: Use manual CSV stub for 13F; short interest optional; renormalize weights when missing.

Integration scope: HMM tab, Kelly tab, Combined Analyticsâ€”all three.

A/B switch: use_IFO boolean; report Sharpe, max DD, bullish precision/recall, Kelly utilization.

No code requested; formulas, schemas, and thresholds are explicit here.

If you want, I can also draft the 1-page Help/Model Card text (plain English) for your appâ€™s sidebar explaining what IFS is and how we use it.